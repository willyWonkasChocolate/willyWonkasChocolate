/*==============================================================================
Project: Adv-1-Servo-Interrupt
Date:    April 8, 2022
This program implements an included servo output function and demonstrates the
use of an interrupt function for background servo pulse generation.
==============================================================================*/
#include    "xc.h"              // Microchip XC8 compiler include file
#include    "stdint.h"          // Include integer definitions
#include    "stdbool.h"         // Include Boolean (true/false) definitions
#include    "UBMP410.h"         // Include UBMP4.1 constant and function definitions
#include    "Servo.h"           // Include servo function definitions
// TODO Set linker ROM ranges to 'default,-0-7FF' under "Memory model" pull-down.
// TODO Set linker code offset to '800' under "Additional options" pull-down.
// Program variable definitions
unsigned char servo1_pos = 0; // Servo 1 position variable
unsigned char timerPeriods = 1; // Interrupt timer periods counter (x5ms)
// Servo interrupt function using TMR0 to count 5ms intervals and generate
// a new servo pulse every 5ms.
void __interrupt() servo(void)
{
   if(TMR0IF == 1 && TMR0IE == 1)  // Validate Timer 0 interrupt
   {
      TMR0IF = 0;             // Clear Timer 0 interrupt flag
      TMR0 = 21;              // Pre-set TMR0 for next 5ms period interval
      timerPeriods --;        // Count down 5ms timer periods
      if(timerPeriods == 0)
      {
          timerPeriods = 1;   // Reset timer period to 5ms servo pulse period
          servo_pulse(SERVO1, servo1_pos);    // Update servo1 position
      }
   }
}
int main(void)
{
  OSC_config();               // Configure internal oscillator for 48 MHz
  UBMP4_config();             // Configure on-board UBMP4 I/O devices
   // Servo output pin configuration
  TRISC = 0b00001110;         // Set H1 as output for Servo1
  
  while(1)
   {
      // Pulse timing test code
//        servo_pulse(SERVO1,servo1Pos);
    
      // Read pushbuttons and adjust servo position
      if(SW5 == 0 && servo1_pos > 0)
      {
          servo1_pos --;
      }
    
      if(SW4 == 0 && servo1_pos < 180)
      {
          servo1_pos ++;
      }
    
//        // Delay between servo pulses
//        __delay_ms(5);
    
      // Delay between pushbutton updates
      __delay_ms(2);
 
       // Activate bootloader if SW1 is pressed.
       if(SW1 == 0)
       {
           RESET();
       }
   }
}
 
/* Learn More - Program Analysis Activities
*
* 1.
*/



________________________________________________________________________________________________________________________________________________________
/*==============================================================================
File: Servo.h
Date: April 8, 2022
UBMP4 Servo function prototypes
Function prototypes and pin definitions for generating servo output pulses on
UBMP4 H1-H8 headers.
==============================================================================*/
 
// Servo header pin bit maps for servo_pulse() function
 
#define SERVO1      0b00000001      // Servo output pin on H1
#define SERVO2      0b00000010      // Servo output pin on H2
#define SERVO3      0b00000100      // Servo output pin on H3
#define SERVO4      0b00001000      // Servo output pin on H4
#define SERVO5      0b00010000      // Servo output pin on H5
#define SERVO6      0b00100000      // Servo output pin on H6
#define SERVO7      0b01000000      // Servo output pin on H7
#define SERVO8      0b10000000      // Servo output pin on H8
 
/**
* Function: servo_pulse(unsigned char servo, unsigned char position)
*
* Creates a single servo pulse 0f 1-2ms length optimized for 90 degree servos.
* Uses SERVO1 - SERVO8 header pin names (corresponding to H1 - H8 header pins)
* defined in the header file as the servo parameter. 8-bit position values
* ranging from 0-255 correspond to output pulse widths from 1-2ms. Ensure that
* your main function repeatedly generates servo pulses every 15-20ms.
*
* Example usage: servo_pulse(SERVO1, 127);
*/
void servo_pulse(unsigned char, unsigned char);
 



________________________________________________________________________________________________________________________________________________________
/*==============================================================================
Library: Servo
Date: April 8, 2022
Servo function to generate servo pulses on UBMP headers H1 - H8. The servo
pulses generated by this function are 1-2ms typical of 90 degree hobby servos.
Modify the code for other servo timings by changing the fixed and variable
code delays.
Before using the servo function, ensure that each servo header pin is set as
a digital output by modifying the UBMP4_config() function in UBMP4.c or by
adding your own PORTC configuration code.
Analog hobby servos require servo pulses to be received every 15-20ms. Ensure
your main loop repeatedly transmits servo pulses at this rate, or use a timer
interrupt and interrupt service routine to implement consistent pulse timing.
=============================================================================*/
 
#include    "xc.h"              // Microchip XC8 compiler include file
#include    "stdint.h"          // Include integer definitions
#include    "stdbool.h"         // Include Boolean (true/false) definitions
 
#include    "UBMP410.h"         // Include UBMP4 constants and functions
#include    "Servo.h"           // Include UBMP4 servo definitions
 
// Create a servo pulse on the specified output (SERVO1 - 8), for a duration
// corresponding to the position value. Ensure PORTC servo pins are previously
// set as digital outputs.
void servo_pulse(unsigned char servo, unsigned char position)
{
   PORTC = PORTC | servo;      // Set servo pin high and make fixed delay
   __delay_us(984);            // (change this value for 180 degree servos)
   for(position; position != 0; position--)   // Extend delay by position value
   {
       _delay(5);             // Clock cycle delay to make 1ms pulse (pos = 255)
   }                           // (change clock delay to modify pulse)
   PORTC = PORTC & (!servo);   // End pulse by resetting servo pin
}
 

